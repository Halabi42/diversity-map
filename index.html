<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/188Qlg350k2YXtTGfgHHntNyloPwSByV5YInf9EIUmio/gviz/tq?tqx=out:csv&sheet=Form%20Responses%201";

  async function fetchCSV() {
    const response = await fetch(CSV_URL);
    const csvText = await response.text();
    const results = Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => h.trim()
    });
    return results.data;
  }

  async function initMap() {
    const map = L.map("map").setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    try {
      const data = await fetchCSV();
      let markerCount = 0;

      data.forEach((row, i) => {
        const latRaw = row["Latitude"];
        const lngRaw = row["Longitude"];
        const lat = parseFloat(latRaw);
        const lng = parseFloat(lngRaw);
        const name = row["Name, and Date of Birth (Optional)"] || `Entry ${i + 1}`;
        const address = row["Birthplace address (Country, City, State)"] || "Unknown";

        if (!isNaN(lat) && !isNaN(lng)) {
          L.marker([lat, lng])
            .addTo(map)
            .bindPopup(`<strong>${name}</strong><br>${address}`);
          markerCount++;
        } else {
          console.warn(`Skipping row ${i + 1} — invalid lat/lng`, {
            latRaw, lngRaw, row
          });
        }
      });

      console.log(`✅ Loaded ${markerCount} markers`);
      if (markerCount === 0) {
        alert("No valid location data found. Please check your spreadsheet.");
      }

    } catch (err) {
      console.error("Error loading or parsing CSV:", err);
      alert("⚠️ Failed to load map data.");
    }
  }

  initMap();
</script>
